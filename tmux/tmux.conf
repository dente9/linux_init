# ==============================================================================
# 0. 基础设置 (自动生成脚本体系)
# ==============================================================================
set -g prefix M-a
unbind C-b
bind M-a send-prefix
set -g detach-on-destroy off

# ------------------------------------------------------------------------------
# 脚本 1: 自动重排 (Reorder) - 保持 1,2,3... 紧密排列
# ------------------------------------------------------------------------------
run-shell 'mkdir -p ~/.tmux'
run-shell 'echo "#!/bin/bash" > ~/.tmux/reorder.sh'
run-shell 'echo "tmux rename-session -t 0 9999 2>/dev/null" >> ~/.tmux/reorder.sh'
run-shell 'echo "sessions=\$(tmux list-sessions -F \"##{session_name}\" 2>/dev/null | grep -E \"^[0-9]+\$\" | sort -n)" >> ~/.tmux/reorder.sh'
run-shell 'echo "new=1" >> ~/.tmux/reorder.sh'
run-shell 'echo "for old in \$sessions; do" >> ~/.tmux/reorder.sh'
run-shell 'echo "  if [ \"\$old\" -ne \"\$new\" ]; then" >> ~/.tmux/reorder.sh'
run-shell 'echo "      tmux rename-session -t \"\$old\" \"\$new\" 2>/dev/null" >> ~/.tmux/reorder.sh'
run-shell 'echo "  fi" >> ~/.tmux/reorder.sh'
run-shell 'echo "  new=\$((new+1))" >> ~/.tmux/reorder.sh'
run-shell 'echo "done" >> ~/.tmux/reorder.sh'
run-shell 'chmod +x ~/.tmux/reorder.sh'

# 绑定钩子 (Hooks)
set-hook -g client-attached 'run-shell "~/.tmux/reorder.sh"'
set-hook -g session-created 'run-shell "~/.tmux/reorder.sh"'
set-hook -g session-closed  'run-shell "~/.tmux/reorder.sh"'

# ------------------------------------------------------------------------------
# 脚本 2: 交换位置 (Swap) - 左右移动 Session
# ------------------------------------------------------------------------------
# 用法: ~/.tmux/swap_session.sh prev (向前移) 或 next (向后移)
run-shell 'echo "#!/bin/bash" > ~/.tmux/swap_session.sh'
run-shell 'echo "direction=\$1" >> ~/.tmux/swap_session.sh'
run-shell 'echo "current=\$(tmux display-message -p \"##S\")" >> ~/.tmux/swap_session.sh'
# 计算目标 ID
run-shell 'echo "if [ \"\$direction\" == \"prev\" ]; then target=\$((current-1)); else target=\$((current+1)); fi" >> ~/.tmux/swap_session.sh'
# 检查目标是否存在 (例如 1 向前移变成 0 是不允许的，或者移到不存在的 4)
run-shell 'echo "if tmux has-session -t \$target 2>/dev/null && [ \$target -gt 0 ]; then" >> ~/.tmux/swap_session.sh'
run-shell 'echo "    tmux rename-session -t \$target 9999_swap" >> ~/.tmux/swap_session.sh' # 把目标暂存
run-shell 'echo "    tmux rename-session -t \$current \$target" >> ~/.tmux/swap_session.sh'     # 把自己移过去
run-shell 'echo "    tmux rename-session -t 9999_swap \$current" >> ~/.tmux/swap_session.sh' # 把暂存的移回来
run-shell 'echo "    tmux switch-client -t \$target" >> ~/.tmux/swap_session.sh'                 # 焦点跟随
run-shell 'echo "fi" >> ~/.tmux/swap_session.sh'
run-shell 'chmod +x ~/.tmux/swap_session.sh'

# 启动时立即执行一次重排
run-shell '~/.tmux/reorder.sh'

# --- 索引与系统设置 ---
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g mouse off
set -s escape-time 0
set -g history-limit 50000
set -g default-terminal "screen-256color"
set -as terminal-features ",xterm-256color:RGB"

# 重载配置: Prefix + r
bind r source-file ~/.tmux.conf \; run-shell '~/.tmux/reorder.sh' \; display "配置重载成功！"

# ==============================================================================
# 1. 移动 Session (新增功能)
# ==============================================================================
# Alt + < (即 Alt + Shift + ,) : Session 向前移 (例如 2->1)
bind -n M-< run-shell "~/.tmux/swap_session.sh prev"

# Alt + > (即 Alt + Shift + .) : Session 向后移 (例如 1->2)
bind -n M-> run-shell "~/.tmux/swap_session.sh next"

# ==============================================================================
# 2. Pane 管理 (IJKL)
# ==============================================================================
bind i split-window -vb -c "#{pane_current_path}"
bind j split-window -hb -c "#{pane_current_path}"
bind k split-window -v  -c "#{pane_current_path}"
bind l split-window -h  -c "#{pane_current_path}"

bind -n M-i select-pane -U
bind -n M-j select-pane -L
bind -n M-k select-pane -D
bind -n M-l select-pane -R

bind -n M-I resize-pane -U 5
bind -n M-J resize-pane -L 5
bind -n M-K resize-pane -D 5
bind -n M-L resize-pane -R 5

bind -n M-f resize-pane -Z

# ==============================================================================
# 3. Window 管理
# ==============================================================================
bind -n M-w new-window -c "#{pane_current_path}"
bind -n M-W confirm-before -p "关闭当前窗口? (Kill Window?) y/n" kill-window

bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8

bind -n M-u swap-window -t -1 \; previous-window
bind -n M-o swap-window -t +1 \; next-window

bind , command-prompt -I "#W" "rename-window '%%'"

# ==============================================================================
# 4. Session 管理
# ==============================================================================
bind -n M-S new-session

bind -n F1 switch-client -t 1
bind -n F2 switch-client -t 2
bind -n F3 switch-client -t 3
bind -n F4 switch-client -t 4
bind -n F5 switch-client -t 5
bind -n F6 switch-client -t 6
bind -n F7 switch-client -t 7
bind -n F8 switch-client -t 8

bind -n M-U switch-client -p
bind -n M-O switch-client -n

bind . command-prompt -I "#S" "rename-session '%%'"

# ==============================================================================
# 5. 任务与移动
# ==============================================================================
bind -n M-! join-pane -t :1
bind -n M-@ join-pane -t :2
bind -n M-# join-pane -t :3
bind -n M-$ join-pane -t :4
bind -n M-% join-pane -t :5
bind -n M-^ join-pane -t :6
bind -n M-& join-pane -t :7
bind -n M-* join-pane -t :8

bind -n M-P break-pane

bind 1 move-window -t 1:
bind 2 move-window -t 2:
bind 3 move-window -t 3:
bind 4 move-window -t 4:
bind 5 move-window -t 5:
bind 6 move-window -t 6:
bind 7 move-window -t 7:
bind 8 move-window -t 8:

# ==============================================================================
# 6. 复制模式
# ==============================================================================
setw -g mode-keys vi
bind -n PageUp copy-mode -u
bind -n PageDown send-keys PageDown
bind -n M-v copy-mode

bind -T copy-mode-vi i send-keys -X cursor-up
bind -T copy-mode-vi k send-keys -X cursor-down
bind -T copy-mode-vi j send-keys -X cursor-left
bind -T copy-mode-vi l send-keys -X cursor-right

bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi V send-keys -X select-line
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# ==============================================================================
# 7. Status Bar
# ==============================================================================
set -g status-style bg=default
set -g status-interval 1
set -g status-left-length 150
set -g status-left "#(tmux list-sessions -F '##{?##{==:##{session_name},#{session_name}},#[bg=magenta]#[fg=white]#[bold],#[bg=colour236]#[fg=colour244]}  ##{session_name}  #[default]' | tr '\\n' ' ')"

set -g status-justify left
set -g window-status-format "#[fg=colour244,bg=default] #I:#W "
set -g window-status-current-format "#[fg=magenta,bg=default,bold] #I:#W "
set -g status-right "#[fg=white]%H:%M"

# ==============================================================================
# 8. 布局
# ==============================================================================
bind -n M-Space next-layout
bind -n M-[ swap-pane -U
bind -n M-] swap-pane -D
bind -n M-= select-layout -E