# ==============================================================================
# 0. 基础设置 (Basic Setup)
# ==============================================================================
# 设置前缀为 Alt+a
set -g prefix M-a
unbind C-b
bind M-a send-prefix
set -g detach-on-destroy off
# --- 核心修复：强制 Session 从 1 开始 (无需修改 Shell) ---
# 1. 钩子：客户端连接时，如果存在 Session 0，改为 1
set-hook -g client-attached 'if-shell "tmux has-session -t 0 2>/dev/null" "rename-session -t 0 1"'
# 2. 钩子：创建新 Session 时，如果名字是 0，改为 1
set-hook -g session-created 'if-shell "tmux has-session -t 0 2>/dev/null" "rename-session -t 0 1"'
# 3. 启动加载时：尝试改名 (针对 reload 场景)
if-shell "tmux has-session -t 0 2>/dev/null" "rename-session -t 0 1"

# --- 索引与系统设置 ---
set -g base-index 1         # 窗口索引从 1 开始
setw -g pane-base-index 1   # Pane 索引从 1 开始
set -g renumber-windows on  # 关闭窗口后自动重新编号
set -g mouse off            # 【已禁用鼠标模式】
set -s escape-time 0        # 消除 ESC 延时 (对 Vim 友好)
set -g history-limit 50000  # 回滚缓冲区大小
set -g default-terminal "screen-256color"
set -as terminal-features ",xterm-256color:RGB"

# 重载配置: Prefix + r
bind r source-file ~/.tmux.conf \; display "配置已重载!"

# ==============================================================================
# 1. Pane 管理 (IJKL 宇宙)
# ==============================================================================
# 新建 Pane: Prefix + i/j/k/l (上/左/下/右)
bind i split-window -vb -c "#{pane_current_path}" # 上 (Vertical Bottom-up)
bind j split-window -hb -c "#{pane_current_path}" # 左 (Horizontal Backward)
bind k split-window -v  -c "#{pane_current_path}" # 下 (Vertical)
bind l split-window -h  -c "#{pane_current_path}" # 右 (Horizontal)

# 切换焦点: Alt + i/j/k/l
bind -n M-i select-pane -U
bind -n M-j select-pane -L
bind -n M-k select-pane -D
bind -n M-l select-pane -R

# 调整大小: Alt + Shift + i/j/k/l (按住 Shift)
bind -n M-I resize-pane -U 5
bind -n M-J resize-pane -L 5
bind -n M-K resize-pane -D 5
bind -n M-L resize-pane -R 5

# Pane 全屏/恢复: Alt + f
bind -n M-f resize-pane -Z

# ==============================================================================
# 2. Window 管理
# ==============================================================================
# 新建 Window: Alt + w
bind -n M-w new-window -c "#{pane_current_path}"

# 关闭 Window: Alt + Shift + w
bind -n M-W confirm-before -p "关闭当前窗口? (Kill Window?) y/n" kill-window

# 切换焦点: Alt + 1 ~ 8
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8

bind -n M-u swap-window -t -1 \; previous-window
bind -n M-o swap-window -t +1 \; next-window

# 重命名 Window: Prefix + ,
bind , command-prompt -I "#W" "rename-window '%%'"

# ==============================================================================
# 3. Session 管理
# ==============================================================================
# 新建 Session: Alt + Shift + s
bind -n M-S new-session

# 切换焦点 (绝对): F1 ~ F8
bind -n F1 switch-client -t 1
bind -n F2 switch-client -t 2
bind -n F3 switch-client -t 3
bind -n F4 switch-client -t 4
bind -n F5 switch-client -t 5
bind -n F6 switch-client -t 6
bind -n F7 switch-client -t 7
bind -n F8 switch-client -t 8

# 切换焦点 (相对): Alt + Shift + u (上一个), Alt + Shift + o (下一个)
# 注意：这里使用大写 U/O 代表按住 Shift
bind -n M-U switch-client -p
bind -n M-O switch-client -n

# 重命名 Session: Prefix + .
bind . command-prompt -I "#S" "rename-session '%%'"

# ==============================================================================
# 4. 任务与移动 (跨界操作)
# ==============================================================================
# Pane -> 移动到指定 Window (Join): Alt + Shift + 1~8
# 键盘符号映射: Shift+1=!, Shift+2=@ ...
bind -n M-! join-pane -t :1
bind -n M-@ join-pane -t :2
bind -n M-# join-pane -t :3
bind -n M-$ join-pane -t :4
bind -n M-% join-pane -t :5
bind -n M-^ join-pane -t :6
bind -n M-& join-pane -t :7
bind -n M-* join-pane -t :8

# Pane -> 独立成 Window (Break): Alt + Shift + p
bind -n M-P break-pane

# Window -> 移动到其他 Session: Prefix + 1~8
# 注意: 目标 Session (1-8) 必须存在
bind 1 move-window -t 1:
bind 2 move-window -t 2:
bind 3 move-window -t 3:
bind 4 move-window -t 4:
bind 5 move-window -t 5:
bind 6 move-window -t 6:
bind 7 move-window -t 7:
bind 8 move-window -t 8:

# ==============================================================================
# 5. 翻页与复制模式 (Copy Mode)
# ==============================================================================
setw -g mode-keys vi

# 翻页: PageUp / PageDown
bind -n PageUp copy-mode -u
bind -n PageDown send-keys PageDown

# 进入复制模式: Alt + c
bind -n M-c copy-mode

# 复制模式下的移动 (IJKL)
bind -T copy-mode-vi i send-keys -X cursor-up
bind -T copy-mode-vi k send-keys -X cursor-down
bind -T copy-mode-vi j send-keys -X cursor-left
bind -T copy-mode-vi l send-keys -X cursor-right

# 选择与复制
bind -T copy-mode-vi c send-keys -X begin-selection           # v: 字符选择
bind -T copy-mode-vi f send-keys -X select-line               # V: 行选择
bind -T copy-mode-vi v send-keys -X copy-selection-and-cancel # y: 复制

# ==============================================================================
# 6. 外观配置 (Status Bar)
# ==============================================================================
set -g status-style bg=default
set -g status-interval 1
set -g status-left-length 150

# 左侧 Session 列表 (当前 Session 高亮显示)
set -g status-left "#(tmux list-sessions -F '##{?##{==:##{session_name},#{session_name}},#[bg=magenta]#[fg=white]#[bold],#[bg=colour236]#[fg=colour244]}  ##{session_name}  #[default]' | tr '\\n' ' ')"

# 中间 Window 列表
set -g status-justify left
set -g window-status-format "#[fg=colour244,bg=default] #I:#W "
set -g window-status-current-format "#[fg=magenta,bg=default,bold] #I:#W "

# 右侧 时间
set -g status-right "#[fg=white]%H:%M"

# ==============================================================================
# 7. 布局与维护
# ==============================================================================
# 循环切换预设布局 (水平/垂直/平铺...): Alt + Space
bind -n M-Space next-layout

# 交换 Pane 位置 (移动当前 Pane): Alt + [ 或 ]
bind -n M-[ swap-pane -U
bind -n M-] swap-pane -D

# 重新平均分配 Pane 大小: Alt + =
bind -n M-= select-layout -E